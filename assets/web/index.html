<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>peer-wan UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #0c0c16; color: #e6e6f0; }
    h1 { margin-bottom: 4px; }
    .card { background: #141426; padding: 12px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    label { display: inline-block; margin-right: 8px; }
    input { padding: 4px 6px; margin-right: 8px; background: #0f0f20; color: #e6e6f0; border: 1px solid #2a2a4a; border-radius: 4px; }
    button { padding: 6px 10px; background: #2d7df6; border: none; color: white; border-radius: 4px; cursor: pointer; }
    .btn-secondary { background: #414166; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 6px; border-bottom: 1px solid #2a2a4a; text-align: left; }
    th { color: #8fb3ff; }
    .pill { padding: 2px 6px; border-radius: 10px; font-size: 12px; }
    .pill.up { background: #173f2f; color: #7cf19c; }
    .pill.down { background: #432020; color: #ff8a8a; }
    #graph { width: 100%; height: 400px; background: #0f0f20; border: 1px solid #2a2a4a; border-radius: 8px; margin-top: 8px; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    #overlay .box { background: #141426; padding: 16px; border-radius: 8px; width: 320px; }
    #overlay input { width: 100%; margin: 6px 0; }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="box">
      <h3 id="overlayTitle">登录</h3>
      <p id="overlayDesc"></p>
      <label>API 基址</label>
      <input id="overlayBase">
    <label>用户名</label>
    <input id="overlayUser">
    <label>密码</label>
    <input id="overlayPass" type="password">
    <button onclick="submitOverlay('login')">登录</button>
    <button class="btn-secondary" onclick="submitOverlay('register')">注册(仅首次)</button>
  </div>
</div>
  <h1>peer-wan 控制台</h1>
  <div class="card">
    <label>API 基址</label><input id="base" value="" placeholder="http://127.0.0.1:8080">
    <label>Token</label><input id="token" value="" placeholder="X-Auth-Token">
    <button onclick="reloadAll()">刷新</button>
  </div>
  <div class="card">
    <h3>状态</h3>
    <div id="status"></div>
  </div>
  <div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#141426; padding:16px; border-radius:8px; width:360px;">
      <h3>编辑节点</h3>
      <div><label>Node ID</label><input id="editId" readonly></div>
      <div><label>Overlay</label><input id="editOverlay" placeholder="10.10.x.1/32"></div>
      <div><label>Endpoints</label><input id="editEndpoints" placeholder="ip:port,ip:port"></div>
      <div><label>CIDRs</label><input id="editCidrs" placeholder="10.10.1.0/24"></div>
      <div><label>Listen</label><input id="editListen" placeholder="51820"></div>
      <div><label>PublicKey</label><input id="editPub" placeholder="(可留空保留原值)"></div>
      <div style="margin-top:10px;">
        <button onclick="submitEdit()">保存</button>
        <button class="btn-secondary" onclick="closeEdit()">取消</button>
      </div>
    </div>
  </div>
  <div id="peerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#141426; padding:16px; border-radius:8px; width:420px; max-height:80vh; overflow:auto;">
      <h3>对端 Endpoint 选择</h3>
      <p id="peerTitle"></p>
      <div id="peerList"></div>
      <div style="margin-top:10px;">
        <button onclick="submitPeerConfig()">保存</button>
        <button class="btn-secondary" onclick="closePeerConfig()">取消</button>
      </div>
    </div>
  </div>
  <div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#141426; padding:16px; border-radius:8px; width:360px;">
      <h3>编辑节点</h3>
      <div><label>Node ID</label><input id="editId" readonly></div>
      <div><label>Overlay</label><input id="editOverlay" placeholder="10.10.x.1/32"></div>
      <div><label>Endpoints</label><input id="editEndpoints" placeholder="ip:port,ip:port"></div>
      <div><label>CIDRs</label><input id="editCidrs" placeholder="10.10.1.0/24"></div>
      <div><label>Listen</label><input id="editListen" placeholder="51820"></div>
      <div><label>PublicKey</label><input id="editPub" placeholder="(可留空保留原值)"></div>
      <div style="margin-top:10px;">
        <button onclick="submitEdit()">保存</button>
        <button class="btn-secondary" onclick="closeEdit()">取消</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>节点</h3>
    <div id="nodes"></div>
    <div style="margin-top:8px;">
      <label>Node ID</label><input id="detailNode" placeholder="edge-1" style="width:120px;">
      <button class="btn-secondary" onclick="showAddNode()">添加节点</button>
      <button onclick="loadPlan()">查看计划</button>
      <button class="btn-secondary" onclick="savePlanSnapshot()">保存快照</button>
      <button class="btn-secondary" onclick="diffPlan()">对比上次快照</button>
      <button class="btn-secondary" onclick="loadPlanHistory()">加载历史</button>
      <button class="btn-secondary" onclick="rollbackPlan()">回滚所选版本</button>
      <button onclick="loadNodeDetail()">查看详情</button>
      <button class="btn-secondary" onclick="diagnosePlan()">诊断计划</button>
    </div>
    <div style="margin-top:8px;">
      <h4>出口/策略配置</h4>
      <label>出口 PeerID</label><input id="egressPeer" placeholder="peer-id" style="width:120px;">
      <label>策略前缀</label><input id="policyPrefix" placeholder="8.8.8.0/24 (可留空)" style="width:150px;">
      <label>域名(逗号)</label><input id="policyDomains" placeholder="example.com,ip.sb" style="width:180px;">
      <label>经由节点</label><input id="policyVia" placeholder="peer-id" style="width:120px;">
      <button class="btn-secondary" onclick="addPolicy()">添加规则</button>
      <button onclick="submitPolicy()">提交策略</button>
      <div id="policyList"></div>
    </div>
    <div id="plan"></div>
    <div id="planHistory"></div>
    <div id="provisionCmd"></div>
    <div id="nodeDetail"></div>
  </div>
  <div class="card">
    <h3>健康</h3>
    <div id="health"></div>
  </div>
  <div class="card">
    <h3>拓扑（基于健康延迟的临时视图）</h3>
    <div id="topology"></div>
    <canvas id="graph"></canvas>
  </div>
  <div class="card">
    <h3>审计</h3>
    <div id="audit"></div>
  </div>
  <script>
    const baseInput = document.getElementById('base');
    const tokenInput = document.getElementById('token');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayDesc = document.getElementById('overlayDesc');
    const overlayBase = document.getElementById('overlayBase');
    const overlayUser = document.getElementById('overlayUser');
    const overlayPass = document.getElementById('overlayPass');
    const defaultBase = localStorage.getItem('peerwan_base') || window.location.origin || 'http://127.0.0.1:8080';
    const urlToken = new URLSearchParams(window.location.search).get('token');
    if (urlToken) { localStorage.setItem('peerwan_token', urlToken); }
    baseInput.value = defaultBase;
    tokenInput.value = localStorage.getItem('peerwan_token') || '';
    let lastPlan = null;
    let policyRules = [];
    let peerConfigCache = {};
    function showAddNode() {
      const nodeId = prompt('输入新节点 ID，仅输入名称即可');
      if (!nodeId) return;
      const body = {id: nodeId};
      api('/api/v1/nodes/prepare', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
        .then((resp)=>{
          const cmd = resp.command || '';
          const msg = `
<p>已为 ${resp.id} 生成一键脚本：</p>
<pre style="white-space:pre-wrap;background:#0f0f20;padding:8px;border-radius:6px;border:1px solid #2a2a4a;">${cmd}</pre>
<p>Overlay: ${resp.overlayIp} | ProvisionToken: ${resp.provisionToken}</p>`;
          document.getElementById('provisionCmd').innerHTML = msg;
          navigator.clipboard?.writeText(cmd).catch(()=>{});
          alert('已生成脚本并复制到剪贴板，登陆节点执行即可');
          reloadAll();
        })
        .catch(e=>alert('生成失败: '+e));
    }

    async function api(path, options={}) {
      const base = baseInput.value.replace(/\/+$/, '');
      const token = tokenInput.value;
      localStorage.setItem('peerwan_base', base);
      localStorage.setItem('peerwan_token', token);
      const headers = options.headers || {};
      if (token) headers['Authorization'] = 'Bearer '+token;
      const res = await fetch(base + path, {...options, headers});
      if (!res.ok) {
        if (res.status === 401) {
          showOverlay('login');
          throw new Error(path + ' unauthorized');
        }
        throw new Error(path + ' ' + res.status);
      }
      return res.json();
    }

    function renderTable(el, columns, rows) {
      if (!rows || !rows.length) { el.innerHTML = '<p>无数据</p>'; return; }
      let html = '<table><thead><tr>';
      columns.forEach(c => html += `<th>${c.label}</th>`);
      html += '</tr></thead><tbody>';
      rows.forEach(r => {
        html += '<tr>';
        columns.forEach(c => html += `<td>${c.render(r)}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      el.innerHTML = html;
    }

    async function loadNodes() {
      const data = arr(await api('/api/v1/nodes'));
      renderTable(document.getElementById('nodes'), [
        {label:'ID', render:r=>r.id},
        {label:'Endpoints', render:r=>(r.endpoints||[]).join(', ')},
        {label:'CIDRs', render:r=>(r.cidrs||[]).join(', ')},
        {label:'Overlay', render:r=>r.overlayIp||''},
        {label:'ASN', render:r=>r.asn||''},
        {label:'Version', render:r=>r.configVersion||''},
        {label:'安装', render:r=>`<button onclick="showInstall('${r.id}')">安装命令</button>`},
        {label:'编辑', render:r=>`<button onclick="openEdit('${r.id}')">编辑</button>`},
        {label:'对端Endpoint', render:r=>`<button onclick="openPeerConfig('${r.id}')">配置</button>`},
      ], data);
    }

    async function loadHealth() {
      const data = arr(await api('/api/v1/health'));
      renderTable(document.getElementById('health'), [
        {label:'Node', render:r=>r.nodeId},
        {label:'状态', render:r=>`<span class="pill ${r.status==='down'?'down':'up'}">${r.status||'unknown'}</span>`},
        {label:'延迟(ms)', render:r=>JSON.stringify(r.latencyMs||{})},
        {label:'丢包(%)', render:r=>JSON.stringify(r.packetLoss||{})},
        {label:'FRR邻居', render:r=>JSON.stringify(r.frrState||{})},
        {label:'时间', render:r=>r.timestamp},
      ], data);
      return data;
    }

    async function loadAudit() {
      const data = arr(await api('/api/v1/audit'));
      renderTable(document.getElementById('audit'), [
        {label:'时间', render:r=>r.timestamp},
        {label:'操作者', render:r=>r.actor},
        {label:'动作', render:r=>r.action},
        {label:'目标', render:r=>r.target},
        {label:'详情', render:r=>r.detail||''},
      ], data);
    }

    async function loadPlan() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      const data = await api('/api/v1/plan?nodeId='+encodeURIComponent(nodeId));
      lastPlan = data;
      policyRules = data.policyRules || [];
      document.getElementById('egressPeer').value = data.egressPeerId || '';
      renderPolicyList();
      loadPolicy(nodeId);
      let html = `<p>计划版本: ${data.configVersion||''} | 消息: ${data.message||''}</p>`;
      document.getElementById('plan').innerHTML = html;
      renderTable(document.getElementById('plan'), [
        {label:'Peer', render:r=>r.id},
        {label:'Endpoint', render:r=>r.endpoint||''},
        {label:'AllowedIPs', render:r=>(r.allowedIPs||[]).join(', ')},
      ], data.wireGuardPeers || []);
    }

    async function loadPlanHistory() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      const data = await api('/api/v1/plan/history?nodeId='+encodeURIComponent(nodeId));
      planHistoryCache = data.reverse();
      renderTimeline();
    }

    async function rollbackPlan() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      if (!planHistoryCache.length) { alert('请先加载历史'); return; }
      const selected = document.querySelector('input[name="planVersion"]:checked');
      if (!selected) { alert('请选择一个版本'); return; }
      const vNum = parseInt(selected.value, 10);
      const base = baseInput.value.replace(/\/+$/, '');
      const token = tokenInput.value;
      const res = await fetch(base + '/api/v1/plan/rollback', {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{}),
        body: JSON.stringify({nodeId, version:vNum})
      });
      if (!res.ok) { alert('回滚失败: '+res.status); return; }
      const body = await res.json();
      alert('回滚完成，已更新全局版本: '+(body.version||'')+'，请等待 Agent 拉取新版计划');
      loadPlanHistory();
    }

    async function loadNodeDetail() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      const health = arr(await api('/api/v1/health'));
      const h = (health||[]).find(x=>x.nodeId===nodeId);
      if (!h) { document.getElementById('nodeDetail').innerHTML = '<p>无健康数据</p>'; return; }
      let html = '<p><b>延迟</b>: '+JSON.stringify(h.latencyMs||{})+'</p>';
      html += '<p><b>丢包</b>: '+JSON.stringify(h.packetLoss||{})+'</p>';
      html += '<p><b>FRR 邻居</b>: '+JSON.stringify(h.frrState||{})+'</p>';
      document.getElementById('nodeDetail').innerHTML = html;
    }

    async function loadTopology() {
      const health = arr(await api('/api/v1/health'));
      if (!health.length) { document.getElementById('topology').innerHTML = '<p>无健康数据</p>'; drawGraph([]); return; }
      let rows = [];
      health.forEach(h => {
        Object.entries(h.latencyMs || {}).forEach(([peer, ms])=>{
          rows.push({from:h.nodeId,to:peer,latency:ms,loss:(h.packetLoss||{})[peer]||0});
        });
      });
      renderTable(document.getElementById('topology'), [
        {label:'From', render:r=>r.from},
        {label:'To', render:r=>r.to},
        {label:'延迟(ms)', render:r=>r.latency},
        {label:'丢包(%)', render:r=>r.loss},
      ], rows);
      drawGraph(health);
    }

    function drawGraph(health) {
      const canvas = document.getElementById('graph');
      canvas.width = canvas.clientWidth;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const nodes = health.map(h=>h.nodeId);
      if (!nodes.length) return;
      const pos = {};
      const R = Math.min(canvas.width, canvas.height)/2 - 50;
      nodes.forEach((id, idx)=>{
        const angle = 2*Math.PI*idx/nodes.length;
        pos[id] = {
          x: canvas.width/2 + R*Math.cos(angle),
          y: canvas.height/2 + R*Math.sin(angle)
        };
      });
      health.forEach(h=>{
        Object.entries(h.latencyMs||{}).forEach(([peer, ms])=>{
          if (!pos[h.nodeId] || !pos[peer]) return;
          const color = ms<30 ? '#6cf2a3' : ms<80 ? '#f2d36c' : '#f26c6c';
          ctx.strokeStyle = color;
          ctx.globalAlpha = 0.8;
          ctx.beginPath();
          ctx.moveTo(pos[h.nodeId].x, pos[h.nodeId].y);
          ctx.lineTo(pos[peer].x, pos[peer].y);
          ctx.stroke();
          ctx.fillStyle = color;
          ctx.font = '12px Arial';
          const mx = (pos[h.nodeId].x + pos[peer].x)/2;
          const my = (pos[h.nodeId].y + pos[peer].y)/2;
          ctx.fillText(ms+'ms', mx, my);
        });
      });
      nodes.forEach(id=>{
        const p = pos[id];
        ctx.fillStyle = '#2d7df6';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 12, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.font = '12px Arial';
        ctx.fillText(id, p.x-10, p.y-16);
      });
    }

    async function reloadAll() {
      try { await loadStatus(); await loadNodes(); await loadHealth(); await loadAudit(); await loadTopology(); }
      catch (e) { alert('加载失败: '+e); }
    }
    async function loadStatus() {
      const data = await api('/api/v1/info');
      const el = document.getElementById('status');
      el.innerHTML = `
        <p>Store: ${data.store} (${data.storeStatus||'unknown'})</p>
        <p>Consul: ${data.consulAddr||'-'}</p>
        <p>MySQL: ${data.mysql||'-'}</p>
        <p>PublicAddr: ${data.publicAddr||'-'}</p>
        <p>PlanVersion: ${data.planVersion||0}</p>
        <p>Build: ${data.buildVersion||'dev'}</p>
      `;
    }
    function showOverlay(mode) {
      overlay.style.display = 'flex';
      overlayBase.value = baseInput.value;
      const adminSet = localStorage.getItem('peerwan_admin_set') === 'true';
      if (!adminSet) {
        overlayTitle.innerText = '初始化（设置管理员账号）';
        overlayDesc.innerText = '首次注册的用户将作为管理员，后续仅登录，不再开放注册。';
      } else {
        overlayTitle.innerText = '登录';
        overlayDesc.innerText = '请输入管理员用户名/密码';
      }
    }
    async function submitOverlay(action) {
      const adminSet = localStorage.getItem('peerwan_admin_set') === 'true';
      const base = overlayBase.value.replace(/\/+$/, '');
      const user = overlayUser.value.trim();
      const pass = overlayPass.value.trim();
      if (!base || !user || !pass) { alert('请填写完整'); return; }
      let path = '/api/v1/auth/login';
      if (!adminSet && action === 'register') path = '/api/v1/auth/register';
      try {
        const res = await fetch(base + path, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({username:user, password:pass})
        });
        if (!res.ok) { alert('认证失败: '+res.status); return; }
        const data = await res.json();
        if (!data.token) { alert('未返回 token'); return; }
        if (!adminSet && action === 'register') {
          localStorage.setItem('peerwan_admin_set', 'true');
        }
        baseInput.value = base;
        tokenInput.value = data.token;
        localStorage.setItem('peerwan_base', base);
        localStorage.setItem('peerwan_token', data.token);
        overlay.style.display = 'none';
        reloadAll();
      } catch (e) {
        alert('认证异常: '+e);
      }
    }
    // 首次或未登录时展示登录/初始化
    (function initAuth(){
      const adminSet = localStorage.getItem('peerwan_admin_set') === 'true';
      const savedToken = localStorage.getItem('peerwan_token');
      if (!adminSet || !savedToken) {
        showOverlay(adminSet ? 'login' : 'init');
      } else {
        reloadAll();
      }
    })();

    function arr(v){ return Array.isArray(v)?v:[]; }

    async function openPeerConfig(id) {
      if (!id) return;
      const nodes = arr(await api('/api/v1/nodes'));
      const node = nodes.find(n=>n.id===id) || {id};
      peerConfigCache = {nodeId:id, nodes};
      document.getElementById('peerTitle').innerText = `为 ${id} 选择对端 Endpoint`;
      const list = document.getElementById('peerList');
      let html = '';
      nodes.forEach(n=>{
        if (n.id === id) return;
        const eps = arr(n.endpoints);
        const current = (node.peerEndpoints||{})[n.id] || '';
        html += `<div style="margin:8px 0;"><label>${n.id}</label><select data-peer="${n.id}">`;
        html += `<option value="">使用默认</option>`;
        eps.forEach(ep=>{
          const sel = ep===current ? 'selected' : '';
          html += `<option value="${ep}" ${sel}>${ep}</option>`;
        });
        html += `</select></div>`;
      });
      list.innerHTML = html || '<p>暂无其他节点</p>';
      document.getElementById('peerModal').style.display = 'flex';
    }
    function closePeerConfig() {
      document.getElementById('peerModal').style.display = 'none';
    }
    async function submitPeerConfig() {
      if (!peerConfigCache.nodeId) { closePeerConfig(); return; }
      const selects = document.querySelectorAll('#peerList select[data-peer]');
      const overrides = {};
      selects.forEach(s=>{
        if (s.value) overrides[s.getAttribute('data-peer')] = s.value;
      });
      try {
        await api('/api/v1/nodes/register', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id: peerConfigCache.nodeId, peerEndpoints: overrides, force:true})
        });
        alert('对端 Endpoint 已更新');
        closePeerConfig();
        reloadAll();
      } catch (e) {
        alert('更新失败: '+e);
      }
    }

    async function openEdit(id) {
      if (!id) return;
      const nodes = arr(await api('/api/v1/nodes'));
      const node = nodes.find(n=>n.id===id) || {id};
      document.getElementById('editId').value = node.id||'';
      document.getElementById('editOverlay').value = node.overlayIp||'';
      document.getElementById('editEndpoints').value = (node.endpoints||[]).join(',');
      document.getElementById('editCidrs').value = (node.cidrs||[]).join(',');
      document.getElementById('editListen').value = node.listenPort||'51820';
      document.getElementById('editPub').value = node.publicKey||'';
      document.getElementById('editModal').style.display = 'flex';
    }
    function closeEdit() {
      document.getElementById('editModal').style.display = 'none';
    }
    async function submitEdit() {
      const id = document.getElementById('editId').value.trim();
      if (!id) { alert('缺少节点 ID'); return; }
      const body = {
        id,
        publicKey: document.getElementById('editPub').value.trim(),
        overlayIp: document.getElementById('editOverlay').value.trim(),
        cidrs: document.getElementById('editCidrs').value.split(',').map(s=>s.trim()).filter(Boolean),
        endpoints: document.getElementById('editEndpoints').value.split(',').map(s=>s.trim()).filter(Boolean),
        listenPort: parseInt(document.getElementById('editListen').value||'51820',10),
        force: true,
      };
      try {
        await api('/api/v1/nodes/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        alert('节点已更新');
        closeEdit();
        reloadAll();
      } catch (e) {
        alert('更新失败: '+e);
      }
    }

    async function diagnosePlan() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      const token = prompt('可选: ProvisionToken（为空使用 JWT）','');
      try {
        const headers = token ? {'X-Provision-Token':token} : {};
        const data = await api('/api/v1/plan?nodeId='+encodeURIComponent(nodeId), {headers});
        alert('诊断结果:\\n'+JSON.stringify(data,null,2));
      } catch (e) {
        alert('诊断失败: '+e);
      }
    }

    function savePlanSnapshot() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId || !lastPlan) { alert('先加载计划'); return; }
      localStorage.setItem('plan_snapshot_'+nodeId, JSON.stringify(lastPlan));
      alert('已保存快照');
    }

    function diffPlan() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId || !lastPlan) { alert('先加载计划'); return; }
      const saved = localStorage.getItem('plan_snapshot_'+nodeId);
      if (!saved) { alert('没有快照'); return; }
      const oldPlan = JSON.parse(saved);
      const diff = comparePlans(oldPlan, lastPlan);
      document.getElementById('plan').innerHTML += `<p>新增 peers: ${diff.added.join(', ')||'无'}</p><p>移除 peers: ${diff.removed.join(', ')||'无'}</p>`;
    }

    function comparePlans(a, b) {
      const aPeers = new Set((a.wireGuardPeers||[]).map(p=>p.id));
      const bPeers = new Set((b.wireGuardPeers||[]).map(p=>p.id));
      const added=[], removed=[];
      bPeers.forEach(x=>{ if(!aPeers.has(x)) added.push(x); });
      aPeers.forEach(x=>{ if(!bPeers.has(x)) removed.push(x); });
      return {added, removed};
    }

    async function showInstall(id) {
      if (!id) { alert('缺少节点 ID'); return; }
      try {
        const resp = await api('/api/v1/nodes/prepare', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id})
        });
        const cmd = resp.command || '';
        document.getElementById('provisionCmd').innerHTML = `
          <p>节点 ${id} 安装命令：</p>
          <pre style="white-space:pre-wrap;background:#0f0f20;padding:8px;border-radius:6px;border:1px solid #2a2a4a;">${cmd}</pre>
          <p>Overlay: ${resp.overlayIp} | ProvisionToken: ${resp.provisionToken}</p>
        `;
        navigator.clipboard?.writeText(cmd).catch(()=>{});
        alert('已生成安装命令，已复制到剪贴板');
      } catch (e) {
        alert('生成命令失败: '+e);
      }
    }

    function renderTimeline() {
      const el = document.getElementById('planHistory');
      if (!planHistoryCache.length) { el.innerHTML = '<p>无历史</p>'; return; }
      let html = '<div>';
      planHistoryCache.forEach(p=>{
        html += `<label style="display:block;margin:6px 0;">
          <input type="radio" name="planVersion" value="${p.version}">
          v${p.version} | ${p.configVersion} | ${p.createdAt} | peers: ${(p.peers||[]).map(x=>x.id).join(', ')} | sig: ${p.signature? '✓' : '–'} | egress: ${p.egressPeerId||''}
        </label>`;
      });
      html += '</div>';
      el.innerHTML = html;
    }

    function addPolicy() {
      const prefix = document.getElementById('policyPrefix').value.trim();
      const domains = document.getElementById('policyDomains').value.split(',').map(s=>s.trim()).filter(Boolean);
      const via = document.getElementById('policyVia').value.trim();
      if (!prefix && domains.length===0) { alert('前缀和域名至少填一个'); return; }
      if (!via) { alert('请输入经由节点'); return; }
      policyRules.push({prefix, viaNode: via, domains});
      document.getElementById('policyPrefix').value = '';
      document.getElementById('policyDomains').value = '';
      document.getElementById('policyVia').value = '';
      renderPolicyList();
    }

    function renderPolicyList() {
      const el = document.getElementById('policyList');
      if (!policyRules.length) { el.innerHTML = '<p>无策略规则</p>'; return; }
      let html = '<ul>';
      policyRules.forEach((r, idx)=>{
        const dom = (r.domains||[]).join(',');
        html += `<li>${r.prefix||'(域名)'} ${dom?('['+dom+']'):''} -> ${r.viaNode} <button class="btn-secondary" onclick="removePolicy(${idx})">删</button></li>`;
      });
      html += '</ul>';
      el.innerHTML = html;
    }

    function removePolicy(i) {
      policyRules.splice(i,1);
      renderPolicyList();
    }

    async function submitPolicy() {
      const nodeId = document.getElementById('detailNode').value.trim();
      if (!nodeId) { alert('请输入 Node ID'); return; }
      const egressPeer = document.getElementById('egressPeer').value.trim();
      const base = baseInput.value.replace(/\/+$/, '');
      const token = tokenInput.value;
      const res = await fetch(base + '/api/v1/policy', {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{}),
        body: JSON.stringify({nodeId, egressPeerId: egressPeer, policyRules})
      });
      if (!res.ok) { alert('策略提交失败: '+res.status); return; }
      const body = await res.json();
      alert('策略已提交，等待计划刷新\n出口: '+(body.egressPeerId||'')+'\n规则数: '+(body.policyRules||[]).length);
      loadPolicy(nodeId);
    }

    async function loadPolicy(nodeId) {
      const base = baseInput.value.replace(/\/+$/, '');
      const token = tokenInput.value;
      const res = await fetch(base + '/api/v1/policy?nodeId='+encodeURIComponent(nodeId), {
        headers: token?{'Authorization':'Bearer '+token}:{}
      });
      if (!res.ok) return;
      const data = await res.json();
      document.getElementById('egressPeer').value = data.egressPeerId||'';
      policyRules = data.policyRules||[];
      renderPolicyList();
    }
  </script>
</body>
</html>
